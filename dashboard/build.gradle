plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}

group = 'frc.dashboard'
version = '1.0.0'
sourceCompatibility = JavaVersion.VERSION_17
targetCompatibility = JavaVersion.VERSION_17

// Main class for the dashboard application
application {
    mainClass = 'frc.dashboard.FRCDashboardApp'
}

// JavaFX configuration
javafx {
    version = '21.0.1'
    modules = ['javafx.controls', 'javafx.fxml', 'javafx.graphics']
}

repositories {
    mavenCentral()
    maven {
        url = 'https://frcmaven.wpi.edu/artifactory/release/'
    }
}

// Configuration for native libraries
configurations {
    nativeLibs
}

dependencies {
    // WPILib NetworkTables for robot communication
    implementation 'edu.wpi.first.ntcore:ntcore-java:2025.3.2'
    implementation 'edu.wpi.first.wpiutil:wpiutil-java:2025.3.2'
    
    // NetworkTables native libraries for all platforms
    nativeLibs 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:osxuniversal'
    nativeLibs 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:linuxx86-64'
    nativeLibs 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:linuxarm64'
    nativeLibs 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:windowsx86-64'
    
    nativeLibs 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:osxuniversal'
    nativeLibs 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:linuxx86-64'
    nativeLibs 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:linuxarm64'
    nativeLibs 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:windowsx86-64'
    
    // Also add to runtime classpath
    runtimeOnly 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:osxuniversal'
    runtimeOnly 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:linuxx86-64'
    runtimeOnly 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:linuxarm64'
    runtimeOnly 'edu.wpi.first.ntcore:ntcore-jni:2025.3.2:windowsx86-64'
    
    runtimeOnly 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:osxuniversal'
    runtimeOnly 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:linuxx86-64'
    runtimeOnly 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:linuxarm64'
    runtimeOnly 'edu.wpi.first.wpiutil:wpiutil-jni:2025.3.2:windowsx86-64'
    
    // Jackson JSON - Required by NetworkTables for JSON serialization
    implementation 'com.fasterxml.jackson.core:jackson-core:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.15.2'
    
    // JavaFX dependencies (managed by plugin)
    
    // Logging
    implementation 'org.slf4j:slf4j-api:2.0.9'
    implementation 'org.slf4j:slf4j-simple:2.0.9'
    
    // JSON parsing for configuration
    implementation 'com.google.code.gson:gson:2.10.1'
}

// Configure Java compilation to use UTF-8
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

// Task to extract native libraries from JNI JARs
task extractNatives {
    outputs.dir("${buildDir}/natives")
    doLast {
        def nativesDir = file("${buildDir}/natives")
        nativesDir.mkdirs()
        
        configurations.nativeLibs.files.each { file ->
            if (file.name.endsWith('.jar')) {
                copy {
                    from zipTree(file)
                    into nativesDir
                    include 'osx/**/*.dylib'      // macOS with directory structure
                    include 'linux/**/*.so'       // Linux with directory structure
                    include 'windows/**/*.dll'    // Windows with directory structure
                    include '**/*.hash'           // Include hash files too
                    includeEmptyDirs = false
                }
            }
        }
    }
}

// Run task configuration
run {
    dependsOn extractNatives
    
    // Add natives directory to classpath so WPILib RuntimeLoader can find libraries
    classpath += files("${buildDir}/natives")
    
    // Add VM options for JavaFX and native library path
    jvmArgs = [
        '--add-opens', 'javafx.graphics/com.sun.javafx.application=ALL-UNNAMED',
        "-Djava.library.path=${buildDir}/natives"
    ]
    
    // Set system properties for WPILib RuntimeLoader
    systemProperty 'edu.wpi.first.runtime.extractOnStatic', 'false'
    systemProperty 'wpiutil.loadLibrary', 'false'
}

// Create executable jar
jar {
    manifest {
        attributes 'Main-Class': 'frc.dashboard.FRCDashboardApp'
    }
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}
